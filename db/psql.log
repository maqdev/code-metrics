********* QUERY **********
set client_min_messages='warning';
**************************

SET
********* QUERY **********
drop database if exists codemetrics;
**************************

DROP DATABASE
********* QUERY **********
drop role if exists codemetrics_user;
**************************

DROP ROLE
********* QUERY **********
drop role if exists codemetrics;
**************************

DROP ROLE
********* QUERY **********
drop role if exists codemetrics_web_user;
**************************

DROP ROLE
********* QUERY **********
drop role if exists codemetrics_web;
**************************

DROP ROLE
********* QUERY **********
drop role if exists codemetrics_admin_user;
**************************

DROP ROLE
********* QUERY **********
drop role if exists codemetrics_admin;
**************************

DROP ROLE
********* QUERY **********
create role codemetrics inherit valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
create role codemetrics_user login password '1' valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
grant codemetrics to codemetrics_user;
**************************

GRANT ROLE
********* QUERY **********
create role codemetrics_web inherit valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
create role codemetrics_web_user login password '1' valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
grant codemetrics_web to codemetrics_web_user;
**************************

GRANT ROLE
********* QUERY **********
create role codemetrics_admin inherit valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
create role codemetrics_admin_user login password '1' valid until 'infinity';
**************************

CREATE ROLE
********* QUERY **********
grant codemetrics_admin to codemetrics_admin_user;
**************************

GRANT ROLE
********* QUERY **********
create database codemetrics with encoding='UTF8' owner=_postgres;
**************************

CREATE DATABASE
********* QUERY **********
set client_min_messages='warning';
**************************

SET
********* QUERY **********
revoke all on schema public from public;
**************************

REVOKE
********* QUERY **********
grant usage on schema public to group codemetrics;
**************************

GRANT
********* QUERY **********
grant usage on schema public to group codemetrics_web;
**************************

GRANT
********* QUERY **********
grant usage on schema public to group codemetrics_admin;
**************************

GRANT
********* QUERY **********
create table config
(
	name varchar(120) not null,            
	val varchar(120) not null,             
	constraint pk_config primary key (name)
);
**************************

CREATE TABLE
********* QUERY **********
grant select on config to codemetrics, codemetrics_web, codemetrics_admin;
**************************

GRANT
********* QUERY **********
insert into config(name, val) values ('db.version', '0');
**************************

INSERT 0 1
********* QUERY **********
create table project
(
    project_id serial,
	name varchar(120) not null,
	path varchar(120) not null,
	is_deleted bool not null default false,
	created timestamptz not null default now(),
	constraint pk_project primary key (project_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update on project to codemetrics, codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select on project to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table file_group
(
    file_group_id serial,
    project_id int not null,
    name varchar(120) not null,
    mask varchar(120) not null,
    priority int not null,
   	constraint pk_file_group primary key (file_group_id),
    constraint fk_file_group__project foreign key (project_id) references project(project_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update on file_group to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select on file_group to codemetrics, codemetrics_web;
**************************

GRANT
********* QUERY **********
create table file_type
(
    file_type_id serial,
    name varchar(120) not null,
    mask varchar(4096) not null,
    constraint pk_file_type primary key (file_type_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update on file_type to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select, insert on file_type to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on file_type to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table author
(
    author_id serial,
    name varchar(120) not null,
    email varchar(120) not null,
    aliases varchar(4096) not null,
    constraint pk_author primary key (author_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update on author to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select, insert on author to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on author to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table file
(
    file_id serial,
    project_id int not null,
    file_type_id int not null,
    path varchar(4096) not null,
    constraint pk_file primary key (file_id),
    constraint fk_file__project foreign key (project_id) references project(project_id),
    constraint fk_file__file_type foreign key (file_type_id) references file_type(file_type_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update,delete on file to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select, insert on file to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on file to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table commt
(
    commt_id bigserial not null,
    hash varchar(120) not null,
    project_id int not null,
    author_id int not null,
    dt timestamptz not null,
    constraint pk_commt primary key (commt_id),
    constraint fk_commt__project foreign key (project_id) references project(project_id),
    constraint fk_commt__author foreign key (author_id) references author(author_id)
);
**************************

CREATE TABLE
********* QUERY **********
create unique index ix_commt_hash on commt(hash);
**************************

CREATE INDEX
********* QUERY **********
grant select,insert,update,delete on commt to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select,insert,update on commt to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on commt to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table metric_type
(
    metric_type_id smallint not null,
    name varchar(120) not null,
    constraint pk_metric_type primary key (metric_type_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update,delete on metric_type to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select on metric_type to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on metric_type to codemetrics_web;
**************************

GRANT
********* QUERY **********
create table metric
(
    commt_id bigint not null,
    metric_type_id smallint not null,
    value int not null,
    constraint fk_metric__commt foreign key (commt_id) references commt(commt_id),
    constraint fk_metric__metric_type foreign key (metric_type_id) references metric_type(metric_type_id)
);
**************************

CREATE TABLE
********* QUERY **********
grant select,insert,update,delete on metric to codemetrics_admin;
**************************

GRANT
********* QUERY **********
grant select,insert,update,delete on metric to codemetrics;
**************************

GRANT
********* QUERY **********
grant select on metric to codemetrics_web;
**************************

GRANT
